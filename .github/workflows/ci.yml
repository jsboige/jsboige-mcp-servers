name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        server: [quickfiles-server, jupyter-mcp-server, jinavigator-server]

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      run: |
        curl -fsSL https://nodejs.org/dist/v20.18.0/node-v20.18.0-linux-x64.tar.xz | tar -xzf -
        sudo mv node-v20.18.0-linux-x64 /usr/local/bin/node
        echo "export PATH=/usr/local/bin:$PATH" >> $GITHUB_ENV
        echo "/usr/local/bin/node --version" >> $GITHUB_ENV
        node --version
    
    - name: Install dependencies
      run: |
        cd servers/${{ matrix.server }}
        npm ci
    
    - name: Build
      run: |
        cd servers/${{ matrix.server }}
        npm run build
    
    - name: Run tests
      run: |
        cd servers/${{ matrix.server }}
        npm test
    
    - name: Run coverage tests
      run: |
        cd servers/${{ matrix.server }}
        npm run test:coverage
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        directory: servers/${{ matrix.server }}/coverage
        flags: ${{ matrix.server }}
        name: ${{ matrix.server }}-coverage
        fail_ci_if_error: false

  lint:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        server: [quickfiles-server, jupyter-mcp-server, jinavigator-server]

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      run: |
        # Detect Ubuntu version and use appropriate installation method
        if [ -f /etc/os-release ]; then
          . /etc/os-release
          UBUNTU_VERSION=$(echo $VERSION_ID | cut -d. -f1)
        else
          UBUNTU_VERSION="20.04"
        fi
        
        echo "Detected Ubuntu version: $UBUNTU_VERSION"
        
        # Use Node.js v20.18.0 for consistency
        NODE_VERSION="20.18.0"
        
        # Download and extract Node.js
        curl -fsSL https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.xz | tar -xzf -
        
        # Install Node.js to standard location
        sudo mv node-v${NODE_VERSION}-linux-x64 /usr/local/bin/node
        
        # Set up PATH and verify installation
        echo "export PATH=/usr/local/bin:$PATH" >> $GITHUB_ENV
        echo "/usr/local/bin/node --version" >> $GITHUB_ENV
        node --version
        
        # Verify Node.js is working
        npm --version
    
    - name: Install dependencies
      run: |
        cd servers/${{ matrix.server }}
        npm ci
    
    - name: Check README.md exists
      run: |
        cd servers/${{ matrix.server }}
        if [ ! -f README.md ]; then
          echo "README.md is missing for ${{ matrix.server }}"
          exit 1
        fi
    
    - name: Check Jest config exists
      run: |
        cd servers/${{ matrix.server }}
        if [ ! -f jest.config.js ]; then
          echo "jest.config.js is missing for ${{ matrix.server }}"
          exit 1
        fi
    
    - name: Check test files exist
      run: |
        cd servers/${{ matrix.server }}
        if [ ! -d __tests__ ]; then
          echo "Tests directory is missing for ${{ matrix.server }}"
          exit 1
        fi
        
        # Check for specific test files
        if [ ! -f __tests__/error-handling.test.js ]; then
          echo "error-handling.test.js is missing for ${{ matrix.server }}"
          exit 1
        fi
        
        if [ ! -f __tests__/performance.test.js ]; then
          echo "performance.test.js is missing for ${{ matrix.server }}"
          exit 1
        fi

  docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Check main README.md
      run: |
        if [ ! -f README.md ]; then
          echo "Main README.md is missing"
          exit 1
        fi
    
    - name: Check documentation files
      run: |
        if [ ! -d docs ]; then
          echo "Docs directory is missing"
          exit 1
        fi
        
        if [ ! -f docs/getting-started.md ]; then
          echo "getting-started.md is missing"
          exit 1
        fi
        
        if [ ! -f docs/architecture.md ]; then
          echo "architecture.md is missing"
          exit 1
        fi
        
        if [ ! -f docs/troubleshooting.md ]; then
          echo "troubleshooting.md is missing"
          exit 1
        fi
    
    - name: Check server README files
      run: |
        for server in quickfiles-server jupyter-mcp-server jinavigator-server; do
          if [ ! -f servers/$server/README.md ]; then
            echo "README.md is missing for $server"
            exit 1
          fi
        done